/**
 * Created by abhinadduri on 6/18/16.
 */
import {Variable} from '../tao_variable/tao.variable.model';
import {Stats} from '../resources/stats'

export class LocalRun {
    public static downloadTemplate(duration: number, ergTemplate: any, variableList: Variable[], threads: number, name: string) {
        let template = `
        function Event(t,e,n,r,i,o,u,p,s){this.parentEvent=e,this.name=t,this._id=n,this.count=r,this.timestamp=i,this.priority=o,this.func=u,this.params=p,this.trace=s,this.getId=function(){return this._id}}function pendingEvent(t,e,n,r,i,o,u,p,s,a,c){this.name=t,this.parentEvent=e,this._id=n,this.count=r,this.delay=i,this.priority=o,this.func=u,this.params=p,this.trace=s,this.condition=a,this.conditionFunc=c,this.getId=function(){return this._id}}function cancellingEvent(t,e,n,r,i){this.name=t,this.parentEvent=e,this.params=n,this.cancelCondition=r,this.delay=i}function lifoRank(t,e){if(t.count==e.count)return 0;var n=t.count>e.count?-1:1;return t.timestamp==e.timestamp?t.priority!=e.priority&&(n=t.priority<e.priority?-1:1):n=t.timestamp<e.timestamp?-1:1,n}function Scheduler(t){this.clock=0,this.count=0,this.numberOfCancelled={},this.terminate=!1,this.uniqueID={},this.scheduledEvents=new Heap(t),this.pendingEvents=[],this.cancellingEvents=[],this.cancelledDelays=[]}function Engine(t){this.eventRanker=t}var Heap,defaultCmp,floor,heapify,heappop,heappush,heappushpop,heapreplace,insort,min,nlargest,nsmallest,updateItem,_siftdown,_siftup;floor=Math.floor,min=Math.min,defaultCmp=function(t,e){return e>t?-1:t>e?1:0},insort=function(t,e,n,r,i){var o;if(null==n&&(n=0),null==i&&(i=defaultCmp),0>n)throw Error("lo must be non-negative");for(null==r&&(r=t.length);r>n;)o=floor((n+r)/2),i(e,t[o])<0?r=o:n=o+1;return[].splice.apply(t,[n,n-n].concat(e)),e},heappush=function(t,e,n){return null==n&&(n=defaultCmp),t.push(e),_siftdown(t,0,t.length-1,n)},heappop=function(t,e){var n,r;return null==e&&(e=defaultCmp),n=t.pop(),t.length?(r=t[0],t[0]=n,_siftup(t,0,e)):r=n,r},heapreplace=function(t,e,n){var r;return null==n&&(n=defaultCmp),r=t[0],t[0]=e,_siftup(t,0,n),r},heappushpop=function(t,e,n){var r;return null==n&&(n=defaultCmp),t.length&&n(t[0],e)<0&&(r=[t[0],e],e=r[0],t[0]=r[1],_siftup(t,0,n)),e},heapify=function(t,e){var n,r,i,o,u,p;for(null==e&&(e=defaultCmp),o=function(){p=[];for(var e=0,n=floor(t.length/2);0>n?e>n:n>e;0>n?e--:e++)p.push(e);return p}.apply(this).reverse(),u=[],r=0,i=o.length;i>r;r++)n=o[r],u.push(_siftup(t,n,e));return u},updateItem=function(t,e,n){var r;return null==n&&(n=defaultCmp),r=t.indexOf(e),-1!==r?(_siftdown(t,0,r,n),_siftup(t,r,n)):void 0},nlargest=function(t,e,n){var r,i,o,u,p;if(null==n&&(n=defaultCmp),i=t.slice(0,e),!i.length)return i;for(heapify(i,n),p=t.slice(e),o=0,u=p.length;u>o;o++)r=p[o],heappushpop(i,r,n);return i.sort(n).reverse()},nsmallest=function(t,e,n){var r,i,o,u,p,s,a,c,l,h;if(null==n&&(n=defaultCmp),10*e<=t.length){if(u=t.slice(0,e).sort(n),!u.length)return u;for(o=u[u.length-1],c=t.slice(e),p=0,a=c.length;a>p;p++)r=c[p],n(r,o)<0&&(insort(u,r,0,null,n),u.pop(),o=u[u.length-1]);return u}for(heapify(t,n),h=[],i=s=0,l=min(e,t.length);0>l?s>l:l>s;i=0>l?--s:++s)h.push(heappop(t,n));return h},_siftdown=function(t,e,n,r){var i,o,u;for(null==r&&(r=defaultCmp),i=t[n];n>e&&(u=n-1>>1,o=t[u],r(i,o)<0);)t[n]=o,n=u;return t[n]=i},_siftup=function(t,e,n){var r,i,o,u,p;for(null==n&&(n=defaultCmp),i=t.length,p=e,o=t[e],r=2*e+1;i>r;)u=r+1,i>u&&n(t[r],t[u])>=0&&(r=u),t[e]=t[r],e=r,r=2*e+1;return t[e]=o,_siftdown(t,p,e,n)},Heap=function(){function t(t){this.cmp=null!=t?t:defaultCmp,this.nodes=[]}return t.push=heappush,t.pop=heappop,t.replace=heapreplace,t.pushpop=heappushpop,t.heapify=heapify,t.nlargest=nlargest,t.nsmallest=nsmallest,t.prototype.push=function(t){return heappush(this.nodes,t,this.cmp)},t.prototype.pop=function(){return heappop(this.nodes,this.cmp)},t.prototype.peek=function(){return this.nodes[0]},t.prototype.contains=function(t){return-1!==this.nodes.indexOf(t)},t.prototype.replace=function(t){return heapreplace(this.nodes,t,this.cmp)},t.prototype.pushpop=function(t){return heappushpop(this.nodes,t,this.cmp)},t.prototype.heapify=function(){return heapify(this.nodes,this.cmp)},t.prototype.updateItem=function(t){return updateItem(this.nodes,t,this.cmp)},t.prototype.clear=function(){return this.nodes=[]},t.prototype.empty=function(){return 0===this.nodes.length},t.prototype.size=function(){return this.nodes.length},t.prototype.clone=function(){var e;return e=new t,e.nodes=this.nodes.slice(0),e},t.prototype.toArray=function(){return this.nodes.slice(0)},t.prototype.insert=t.prototype.push,t.prototype.top=t.prototype.peek,t.prototype.front=t.prototype.peek,t.prototype.has=t.prototype.contains,t.prototype.copy=t.prototype.clone,t}(),Scheduler.prototype.getClock=function(){return this.clock},Scheduler.prototype.setClock=function(t){this.clock=t},Scheduler.prototype.getCount=function(){return this.count},Scheduler.prototype.getNumberOfCancelled=function(t){return this.numberOfCancelled[t]},Scheduler.prototype.getNumberOfScheduled=function(t){return this.uniqueID[t]},Scheduler.prototype.incrementCancelledNumber=function(t){this.numberOfCancelled.hasOwnProperty(t)?this.numberOfCancelled[t]+=1:this.numberOfCancelled[t]=1},Scheduler.prototype.terminateSimulation=function(){this.terminate=!0},Scheduler.prototype.schedule=function(t,e,n,r,i,o,u){this.uniqueID.hasOwnProperty(t)?this.uniqueID[t]+=1:this.uniqueID[t]=1;var p=new Event(t,e,this.uniqueID[t],this.count,this.clock+n,r,i,o,u);this.scheduledEvents.push(p),this.count+=1},Scheduler.prototype.schedulePending=function(t,e,n,r,i,o,u,p,s){var a=new pendingEvent(t,e,this.uniqueID[t],this.count,n,r,i,o,u,p,s);this.pendingEvents.push(a),this.count+=1},Scheduler.prototype.scheduleCancelling=function(t,e,n,r,i){var o=new cancellingEvent(t,e,n,r,i);this.cancellingEvents.push(o)},Scheduler.prototype.scheduleDelay=function(t,e){this.cancelledDelays.push({delay:t,name:e})},Scheduler.prototype.hasNext=function(){return this.terminate?!1:!this.scheduledEvents.empty()},Scheduler.prototype.next=function(){var t=this.scheduledEvents.pop();return t&&(this.clock=t.timestamp),t},Engine.prototype.log=function(t,e,n){"Run"==t.parentEvent.name&&t.trace?console.log(t.name+" "+t.getId()+" by Run at time "+e.getClock()+" by thread "+(n+1)):t.parentEvent&&t.trace&&console.log(t.name+" "+t.getId()+" by "+t.parentEvent.name+" "+t.parentEvent.getId()+" at time "+e.getClock()+" by thread "+(n+1))},Engine.prototype.step=function(t,e,n,r){var i=n[r];if(i.hasNext()||0!=Object.keys(i.pendingEvents).length){var o=i.getClock(),u=i.next();if(u){for(var p in i.cancellingEvents){{var s=i.cancellingEvents[p];s.params}s.name==u.name&&(s.cancelCondition(t)&&(i.incrementCancelledNumber(s.name),i.scheduleDelay(s.delay,s.name)),delete i.cancellingEvents[p])}for(var a in i.cancelledDelays){var c=i.cancelledDelays[a];if(c.delay+=o-i.getClock(),c.delay<=0&&(delete i.cancelledDelays[a],u.name==c.name))return 0}if(u.timestamp>e)return-1;u.func(i,u.params),this.log(u,i,r)}for(var p in i.pendingEvents){{var l=i.pendingEvents[p];l.params}l.conditionFunc(t)&&(delete i.pendingEvents[p],i.schedule(l.name,l.parentEvent,l.delay,l.priority,l.func,l.params,l.trace))}return u||i.hasNext()||(i.setClock(i.getClock()+1),i.getClock()<=e)?1:-1}return-2},Engine.prototype.execute=function(t,e,n){if(t.length!=n)return void console.log("Error.");for(var r=[],i={},o=[],u=[],p=0;n>p;p++)r.push(new Scheduler(this.eventRanker,e)),i[p]=1,u.push(1),o.push(0);for(var s=0;n>s;s++)t[s].Run(r[s]);for(;0!=Object.getOwnPropertyNames(i).length;){for(var a in i)for(var s=0;s<u[a];s++)if(1==i[a]){var c=this.step(t[a],e,r,parseInt(a));if(o[a]++,i[a]==c,-1==c||-2==c){delete i[a],console.log("Terminating thread "+(parseInt(a)+1));break}}n>1&&Engine.prototype.updateResources(o,u)}},Engine.prototype.updateResources=function(t,e){for(var n=[],r=0,i=0;i<t.length;i++)r+=t[i];for(var o=0;o<t.length;o++)n.push(t[o]/r);n.sort();var u=Math.random(),p=0;if(u<n[0])e[0]+=1;else for(var s=0;s<n.length;s++)p+=n[s],p>u&&(e[s]+=1)};var sim = ` + ergTemplate + `;var compiledFunction = eval('(' + sim + ')');var scenarioList = [];for (var i = 0; i < ` + threads + `; i++) {var code = new compiledFunction();code.stats = new ` + Stats + `();scenarioList.push(code);}`
        for (let i = 0; i < threads; i++) {
            for (let j = 0; j < variableList.length; j++) {
                let evalVar = eval('(' + variableList[j].value + ')');
                template += `\nscenarioList[` + i + `]['` +
                    variableList[j].name + `'] = eval('(' +` + variableList[j].value + ((threads != 1) ? (`[` + i + `]`) : ``) + `+ ')');`
            }
        }
        template += `var eng = new Engine(lifoRank);console.log('Running ` + name + `');eng.execute(scenarioList, ` + duration + `, ` + threads + `);`;
        return template;
    }
}