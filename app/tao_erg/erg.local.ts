/**
 * Created by abhinadduri on 6/18/16.
 */
import {Variable} from '../tao_variable/tao.variable.model';
import {Stats} from '../resources/stats'

export class LocalRun {
    public static downloadTemplate(duration: number, ergTemplate: any, variableList: Variable[], threads: number, name: string, background=true) {
        let template = ``;
        if (background)
            template += `function Event(e,t,n,r,o,i,p,s,u){this.parentEvent=t,this.name=e,this._id=n,this.count=r,this.timestamp=o,this.priority=i,this.func=p,this.params=s,this.trace=u,this.getId=function(){return this._id}}function pendingEvent(e,t,n,r,o,i,p,s,u,a,l){this.name=e,this.parentEvent=t,this._id=n,this.count=r,this.delay=o,this.priority=i,this.func=p,this.params=s,this.trace=u,this.condition=a,this.conditionFunc=l,this.getId=function(){return this._id}}function cancellingEvent(e,t,n,r,o,i){this.name=e,this.parentEvent=t,this.params=n,this.cancelCondition=r,this.delay=o,this.subType=i}function lifoRank(e,t){if(e.count==t.count)return 0;var n=e.count>t.count?-1:1;return e.timestamp==t.timestamp?e.priority!=t.priority&&(n=e.priority<t.priority?-1:1):n=e.timestamp<t.timestamp?-1:1,n}function Scheduler(e){this.clock=0,this.count=0,this.numberOfCancelled={},this.terminate=!1,this.uniqueID={},this.scheduledEvents=new Heap(e),this.pendingEvents=[],this.cancellingEvents=[],this.cancelledDelays=[],this.executeDelay=[],this.executeParamsDelay={}}function Engine(e){this.eventRanker=e}var Heap,defaultCmp,floor,heapify,heappop,heappush,heappushpop,heapreplace,insort,min,nlargest,nsmallest,updateItem,_siftdown,_siftup;floor=Math.floor,min=Math.min,defaultCmp=function(e,t){return t>e?-1:e>t?1:0},insort=function(e,t,n,r,o){var i;if(null==n&&(n=0),null==o&&(o=defaultCmp),0>n)throw Error("lo must be non-negative");for(null==r&&(r=e.length);r>n;)i=floor((n+r)/2),o(t,e[i])<0?r=i:n=i+1;return[].splice.apply(e,[n,n-n].concat(t)),t},heappush=function(e,t,n){return null==n&&(n=defaultCmp),e.push(t),_siftdown(e,0,e.length-1,n)},heappop=function(e,t){var n,r;return null==t&&(t=defaultCmp),n=e.pop(),e.length?(r=e[0],e[0]=n,_siftup(e,0,t)):r=n,r},heapreplace=function(e,t,n){var r;return null==n&&(n=defaultCmp),r=e[0],e[0]=t,_siftup(e,0,n),r},heappushpop=function(e,t,n){var r;return null==n&&(n=defaultCmp),e.length&&n(e[0],t)<0&&(r=[e[0],t],t=r[0],e[0]=r[1],_siftup(e,0,n)),t},heapify=function(e,t){var n,r,o,i,p,s;for(null==t&&(t=defaultCmp),i=function(){s=[];for(var t=0,n=floor(e.length/2);0>n?t>n:n>t;0>n?t--:t++)s.push(t);return s}.apply(this).reverse(),p=[],r=0,o=i.length;o>r;r++)n=i[r],p.push(_siftup(e,n,t));return p},updateItem=function(e,t,n){var r;return null==n&&(n=defaultCmp),r=e.indexOf(t),-1!==r?(_siftdown(e,0,r,n),_siftup(e,r,n)):void 0},nlargest=function(e,t,n){var r,o,i,p,s;if(null==n&&(n=defaultCmp),o=e.slice(0,t),!o.length)return o;for(heapify(o,n),s=e.slice(t),i=0,p=s.length;p>i;i++)r=s[i],heappushpop(o,r,n);return o.sort(n).reverse()},nsmallest=function(e,t,n){var r,o,i,p,s,u,a,l,h,c;if(null==n&&(n=defaultCmp),10*t<=e.length){if(p=e.slice(0,t).sort(n),!p.length)return p;for(i=p[p.length-1],l=e.slice(t),s=0,a=l.length;a>s;s++)r=l[s],n(r,i)<0&&(insort(p,r,0,null,n),p.pop(),i=p[p.length-1]);return p}for(heapify(e,n),c=[],o=u=0,h=min(t,e.length);0>h?u>h:h>u;o=0>h?--u:++u)c.push(heappop(e,n));return c},_siftdown=function(e,t,n,r){var o,i,p;for(null==r&&(r=defaultCmp),o=e[n];n>t&&(p=n-1>>1,i=e[p],r(o,i)<0);)e[n]=i,n=p;return e[n]=o},_siftup=function(e,t,n){var r,o,i,p,s;for(null==n&&(n=defaultCmp),o=e.length,s=t,i=e[t],r=2*t+1;o>r;)p=r+1,o>p&&n(e[r],e[p])>=0&&(r=p),e[t]=e[r],t=r,r=2*t+1;return e[t]=i,_siftdown(e,s,t,n)},Heap=function(){function e(e){this.cmp=null!=e?e:defaultCmp,this.nodes=[]}return e.push=heappush,e.pop=heappop,e.replace=heapreplace,e.pushpop=heappushpop,e.heapify=heapify,e.nlargest=nlargest,e.nsmallest=nsmallest,e.prototype.push=function(e){return heappush(this.nodes,e,this.cmp)},e.prototype.pop=function(){return heappop(this.nodes,this.cmp)},e.prototype.peek=function(){return this.nodes[0]},e.prototype.contains=function(e){return-1!==this.nodes.indexOf(e)},e.prototype.replace=function(e){return heapreplace(this.nodes,e,this.cmp)},e.prototype.pushpop=function(e){return heappushpop(this.nodes,e,this.cmp)},e.prototype.heapify=function(){return heapify(this.nodes,this.cmp)},e.prototype.updateItem=function(e){return updateItem(this.nodes,e,this.cmp)},e.prototype.clear=function(){return this.nodes=[]},e.prototype.empty=function(){return 0===this.nodes.length},e.prototype.size=function(){return this.nodes.length},e.prototype.clone=function(){var t;return t=new e,t.nodes=this.nodes.slice(0),t},e.prototype.toArray=function(){return this.nodes.slice(0)},e.prototype.insert=e.prototype.push,e.prototype.top=e.prototype.peek,e.prototype.front=e.prototype.peek,e.prototype.has=e.prototype.contains,e.prototype.copy=e.prototype.clone,e}(),Scheduler.prototype.getClock=function(){return this.clock},Scheduler.prototype.setClock=function(e){this.clock=e},Scheduler.prototype.getCount=function(){return this.count},Scheduler.prototype.getNumberOfCancelled=function(e){return this.numberOfCancelled[e]},Scheduler.prototype.getNumberOfScheduled=function(e){return this.uniqueID[e]},Scheduler.prototype.incrementCancelledNumber=function(e){this.numberOfCancelled.hasOwnProperty(e)?this.numberOfCancelled[e]+=1:this.numberOfCancelled[e]=1},Scheduler.prototype.terminateSimulation=function(){this.terminate=!0},Scheduler.prototype.schedule=function(e,t,n,r,o,i,p){this.uniqueID.hasOwnProperty(e)?this.uniqueID[e]+=1:this.uniqueID[e]=1;var s=new Event(e,t,this.uniqueID[e],this.count,this.clock+n,r,o,i,p);this.scheduledEvents.push(s),this.count+=1},Scheduler.prototype.schedulePending=function(e,t,n,r,o,i,p,s,u){var a=new pendingEvent(e,t,this.uniqueID[e],this.count,n,r,o,i,p,s,u);this.pendingEvents.push(a),this.count+=1},Scheduler.prototype.scheduleCancelling=function(e,t,n,r,o,i){var p=new cancellingEvent(e,t,n,r,o,i);this.cancellingEvents.push(p)},Scheduler.prototype.scheduleDelay=function(e,t,n,r){this.cancelledDelays.push({delay:e,name:t,type:n,params:r})},Scheduler.prototype.hasNext=function(){return this.terminate?!1:!this.scheduledEvents.empty()},Scheduler.prototype.next=function(){var e=this.scheduledEvents.pop();return e&&(this.clock=e.timestamp),e},Scheduler.prototype.pop=function(){return this.scheduledEvents.pop()},Scheduler.prototype.push=function(e){this.scheduledEvents.push(e)},Engine.prototype.log=function(e,t,n){"Run"==e.parentEvent.name&&e.trace?console.log(e.name+" "+e.getId()+" by Run at time "+t.getClock()+" by thread "+(n+1)):e.parentEvent&&e.trace&&console.log(e.name+" "+e.getId()+" by "+e.parentEvent.name+" "+e.parentEvent.getId()+" at time "+t.getClock()+" by thread "+(n+1))},Engine.prototype.equals=function(e,t){for(var n in e)if(!(t.hasOwnProperty(n)&&typeof e[n]==typeof t[n]&&e[n]==t[n]||JSON.stringify(e[n])==JSON.stringify(t[n])))return!1;return!0},Engine.prototype.flushScheduling=function(e,t){for(var n=[];t.hasNext();){var r=t.pop();r.name!=e&&n.push(r)}for(var o=0;o<n.length;o++)t.push(n[o])},Engine.prototype.flushPending=function(e,t){var n=t.pendingEvents;for(var r in n)r.name==e&&delete n[r]},Engine.prototype.updateCancelled=function(e,t){for(var n in e.cancellingEvents){{var r=e.cancellingEvents[n];r.params}delete e.cancellingEvents[n],r.cancelCondition(t)&&(e.incrementCancelledNumber(r.name),e.scheduleDelay(r.delay,r.name,r.subType,r.params))}},Engine.prototype.step=function(e,t,n,r){var o=n[r];if(o.hasNext()||0!=Object.keys(o.pendingEvents).length){var i=o.getClock(),p=o.next();if(p){this.updateCancelled(o,e);for(var s in o.cancelledDelays){var u=o.cancelledDelays[s];if(u.delay+=i-o.getClock(),u.delay<=0)if(delete o.cancelledDelays[s],"Next"==u.type)o.executeDelay.push(u.name);else if("Params"==u.type)o.executeParamsDelay[u.name]=u.params;else if("All"==u.type)return this.flushScheduling(u.name,o),this.flushPending(u.name,o),0}var a=o.executeDelay.indexOf(p.name);if(-1!=a)return o.executeDelay.splice(a,1),0;if(o.executeParamsDelay.hasOwnProperty(p.name)&&this.equals(o.executeParamsDelay[p.name],p.params))return delete o.executeParamsDelay[p.name],0;if(p.timestamp>t)return-1;p.func(o,p.params),this.log(p,o,r)}for(var l in o.pendingEvents){{var h=o.pendingEvents[l];h.params}h.conditionFunc(e)&&(delete o.pendingEvents[l],o.schedule(h.name,h.parentEvent,h.delay,h.priority,h.func,h.params,h.trace))}if(!p&&!o.hasNext()){this.updateCancelled(o,e),o.setClock(o.getClock()+1);for(var s in o.cancelledDelays){var u=o.cancelledDelays[s];u.delay-=1}if(o.getClock()>t)return-1}return 1}return-2},Engine.prototype.execute=function(e,t,n){if(e.length!=n)return void console.log("Error.");for(var r=[],o={},i=[],p=[],s=0;n>s;s++)r.push(new Scheduler(this.eventRanker,t)),o[s]=1,p.push(1),i.push(0);for(var u=0;n>u;u++)e[u].Run(r[u]);for(;0!=Object.getOwnPropertyNames(o).length;){for(var a in o)for(var u=0;u<p[a];u++)if(1==o[a]){var l=this.step(e[a],t,r,parseInt(a));if(i[a]++,o[a]==l,-1==l||-2==l){delete o[a],console.log("Terminating thread "+(parseInt(a)+1));break}}n>1&&this.updateResources(i,p)}},Engine.prototype.updateResources=function(e,t){for(var n=[],r=0,o=0;o<e.length;o++)r+=e[o];for(var i=0;i<e.length;i++)n.push(e[i]/r);n.sort();var p=Math.random(),s=0;if(p<n[0])t[0]+=1;else for(var u=0;u<n.length;u++)s+=n[u],s>p&&(t[u]+=1)};`;
        template += `var sim = ` + ergTemplate + `;var compiledFunction = eval('(' + sim + ')');var scenarioList = [];for (var i = 0; i < ` + threads + `; i++) {var code = new compiledFunction();code.stats = new ` + Stats + `();scenarioList.push(code);}`
        for (let i = 0; i < threads; i++) {
            for (let j = 0; j < variableList.length; j++) {
                let evalVar = eval('(' + variableList[j].value + ')');
                template += `\nscenarioList[` + i + `]['` +
                    variableList[j].name + `'] = eval('(' +` + variableList[j].value + ((threads != 1) ? (`[` + i + `]`) : ``) + `+ ')');`
            }
        }
        template += `var eng = new Engine(lifoRank);console.log('Running ` + name + `');eng.execute(scenarioList, ` + duration + `, ` + threads + `);`;
        return template;
    }
}